<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cybersecurity Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <div id="introScreen">
        <img src="{{ url_for('static', filename='images/01-logo.png') }}" alt="Il Tuo Logo" id="mainLogo">
        <p id="introText">Decifra, proteggi, anticipa. La tua fortezza digitale inizia qui.</p>
        <button id="enterButton" class="nav-button">Entra</button>
    </div>
    </div>

    <div id="mainContent" class="hidden">
        <h1>Cybersecurity Chatbot</h1>

        <nav id="mainNav">
            <button class="nav-button" data-target="chatCard">Chat Cybersecurity</button>
            <button class="nav-button" data-target="threatCard">Analisi Minaccia</button>
            <button class="nav-button" data-target="emailCard">Verifica Email (Phishing)</button>
            <button class="nav-button" data-target="passwordCard">Analisi Password</button>
            <button class="nav-button" data-target="phoneCard">Verifica Telefono</button>
            <button class="nav-button" data-target="reputationCard">Email Reputation</button>
        </nav>

        <div class="container">
            <div id="chatCard" class="card">
                <div class="card-header">
                    <h2>üí¨ Chat Cybersecurity</h2>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="chat-container" id="chatContainer"></div>
                    <div class="chat-input-container">
                        <textarea id="chatInput" rows="3"
                            placeholder="Fai una domanda sulla sicurezza informatica..."></textarea>
                        <button onclick="chatBot()">Invia</button>
                    </div>
                </div>
            </div>
            <div id="threatCard" class="card">
                <div class="card-header">
                    <h2>Analisi Minaccia</h2>
                    <span class="arrow">‚ñ≤</span>
                </div>
                <div class="card-content">
                    <input id="threatInput" placeholder="Esempio: OSX.VSearch">
                    <button onclick="analyzeThreat()">Analizza</button>
                    <div id="threatResponse" class="response"></div>
                </div>
            </div>
            <div id="phoneCard" class="card">
                <div class="card-header">
                    <h2>Verifica Numero di Telefono</h2>
                    <span class="arrow">‚ñ≤</span>
                </div>
                <div class="card-content">
                    <input type="text" id="phoneInput" placeholder="Esempio: +393471234567">
                    <button onclick="checkPhone()">Verifica</button>
                    <div id="phoneResponse" class="response"></div>
                </div>
            </div>
            <div id="reputationCard" class="card">
                <div class="card-header">
                    <h2>Email Reputation</h2>
                    <span class="arrow">‚ñ≤</span>
                </div>
                <div class="card-content">
                    <input type="text" id="reputationInput" placeholder="Esempio: test@email.com">
                    <button onclick="checkReputation()">Verifica</button>
                    <div id="reputationResponse" class="response"></div>
                </div>
            </div>
            <div id="emailCard" class="card">
                <div class="card-header">
                    <h2>Verifica Email (Phishing)</h2>
                    <span class="arrow">‚ñ≤</span>
                </div>
                <div class="card-content">
                    <textarea id="emailInput" rows="4" placeholder="Incolla qui il contenuto sospetto..."></textarea>
                    <button onclick="checkEmail()">Verifica</button>
                    <div id="emailResponse" class="response"></div>
                </div>
            </div>

            <div id="passwordCard" class="card">
                <div class="card-header">
                    <h2>Analisi Password</h2>
                    <span class="arrow">‚ñ≤</span>
                </div>
                <div class="card-content">
                    <input type="text" id="passwordInput" placeholder="Scrivi la password da analizzare">
                    <button onclick="checkPassword()">Analizza</button>
                    <div id="passwordResponse" class="response"></div>
                </div>
            </div>

        </div>
    </div>
    <script>
        const BASE_URL = "http://localhost:5000"; // URL base per le tue chiamate Flask

        async function checkPhone() {
            const phone = document.getElementById("phoneInput").value;
            const resBox = document.getElementById("phoneResponse");
            resBox.innerText = "‚è≥ Verifica in corso...";
            try {
                const res = await fetch(`${BASE_URL}/check-phone-llm`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phone })
                });
                const data = await res.json();
                resBox.innerText = data.spiegazione || "Errore: Nessuna risposta valida.";
            } catch (err) {
                resBox.innerText = "Errore di connessione o del server.";
                console.error("Errore verifica telefono:", err);
            }
        }
        async function checkReputation() {
            const email = document.getElementById("reputationInput").value;
            const resBox = document.getElementById("reputationResponse");
            resBox.innerText = "‚è≥ Verifica in corso...";
            try {
                const res = await fetch(`${BASE_URL}/email-reputation-llm`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                resBox.innerText = data.spiegazione || "Errore: Nessuna risposta valida.";
            } catch (err) {
                resBox.innerText = "Errore di connessione o del server.";
                console.error("Errore email reputation:", err);
            }
        }
        // Funzione per l'analisi delle minacce
        async function analyzeThreat() {
            const input = document.getElementById("threatInput").value;
            const resBox = document.getElementById("threatResponse");
            resBox.innerText = "‚è≥ Analisi in corso...";
            try {
                const res = await fetch(`${BASE_URL}/analyze-threat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ input })
                });
                const data = await res.json();
                resBox.innerText = data.response || "Errore: Nessuna risposta valida.";
            } catch (err) {
                resBox.innerText = "Errore di connessione o del server.";
                console.error("Errore nell'analisi minaccia:", err);
            }
        }

        // Funzione per la verifica email (phishing)
        async function checkEmail() {
            const email = document.getElementById("emailInput").value;
            const resBox = document.getElementById("emailResponse");
            resBox.innerText = "‚è≥ Analisi in corso...";
            try {
                const res = await fetch(`${BASE_URL}/check-email`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                resBox.innerText = data.response || "Errore: Nessuna risposta valida.";
            } catch (err) {
                resBox.innerText = "Errore di connessione o del server.";
                console.error("Errore nella verifica email:", err);
            }
        }

        // Funzione per l'analisi password
        async function checkPassword() {
            const password = document.getElementById("passwordInput").value;
            const resBox = document.getElementById("passwordResponse");
            resBox.innerText = "‚è≥ Analisi in corso...";
            try {
                const res = await fetch(`${BASE_URL}/check-password`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                resBox.innerText = data.response || "Errore: Nessuna risposta valida.";
            } catch (err) {
                resBox.innerText = "Errore di connessione o del server.";
                console.error("Errore nell'analisi password:", err);
            }
        }

        // Funzione per la chat con il chatbot
        async function chatBot() {
            const message = document.getElementById("chatInput").value;
            const chatContainer = document.getElementById("chatContainer");
            const inputField = document.getElementById("chatInput");

            if (!message.trim()) return;

            // Aggiungi il messaggio dell'utente
            addMessage(message, true);

            // Pulisci l'input
            inputField.value = "";

            try {
                const res = await fetch(`${BASE_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message })
                });
                const data = await res.json();

                // Aggiungi la risposta del bot
                addMessage(data.response || "Errore", false);

                // Scorri alla fine della chat
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (err) {
                addMessage("Errore di connessione", false);
            }
        }

        function addMessage(content, isUser) {
            const chatContainer = document.getElementById("chatContainer");
            const messageDiv = document.createElement("div");
            messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;

            const time = new Date().toLocaleTimeString();

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${content}
                    <div class="message-time">${time}</div>
                </div>
            `;

            chatContainer.appendChild(messageDiv);
        }

        // --- Logica di Interfaccia Utente (UI) ---

        document.addEventListener('DOMContentLoaded', function () {
            const introScreen = document.getElementById('introScreen');
            const mainContent = document.getElementById('mainContent');
            const enterButton = document.getElementById('enterButton'); // Il nuovo bottone "Entra"
            const navButtons = document.querySelectorAll('.nav-button'); // Bottoni di navigazione principali
            const allCards = document.querySelectorAll('.card'); // Tutte le card collassabili

            /**
             * Gestisce la transizione dalla schermata introduttiva al contenuto principale.
             * Nasconde introScreen e mostra mainContent con animazioni fluide.
             */
            function showMainContent() {
                // Aggiunge la classe 'hidden' a introScreen per attivare la sua animazione di scomparsa
                introScreen.classList.add('hidden');
                // Imposta un timer per far apparire mainContent dopo che introScreen √® quasi scomparso
                // Il ritardo (1000ms = 1s) deve corrispondere alla durata della transizione CSS di introScreen
                setTimeout(() => {
                    mainContent.classList.remove('hidden'); // Rimuove 'display: none' per renderlo visibile al layout
                    mainContent.classList.add('visible');   // Aggiunge 'visible' per attivare l'animazione di comparsa
                    document.body.style.overflow = 'auto'; // Riabilita lo scroll della pagina
                }, 1000); // 1 secondo di ritardo
            }

            /**
             * Gestisce l'apertura e chiusura delle singole card.
             * Chiude tutte le altre card e apre quella specificata.
             * @param {string} targetCardId - L'ID della card da attivare/disattivare.
             */
            function toggleCard(targetCardId) {
                allCards.forEach(card => {
                    const cardHeader = card.querySelector('.card-header');
                    const arrow = cardHeader.querySelector('.arrow');

                    if (card.id === targetCardId) {
                        // Se √® la card cliccata (o la card target da un bottone di navigazione)
                        // Toggle della classe 'active' per aprirla/chiuderla
                        const isActive = card.classList.toggle('active');
                        // Ruota la freccia di conseguenza
                        if (isActive) {
                            arrow.classList.add('rotated');
                        } else {
                            arrow.classList.remove('rotated');
                        }
                    } else {
                        // Chiudi tutte le altre card e resetta la loro freccia
                        card.classList.remove('active');
                        arrow.classList.remove('rotated');
                    }
                });
            }

            // --- Event Listeners ---

            // 1. Event listener per il bottone "Entra" sulla schermata introduttiva
            // Se il bottone esiste nell'HTML (√® facoltativo, vedi spiegazione precedente)
            if (enterButton) {
                enterButton.addEventListener('click', showMainContent);
            }

            // 2. Event listeners per i bottoni di navigazione principali (Analisi Minaccia, Verifica Email, ecc.)
            navButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Se l'intro √® ancora visibile, la nascondiamo e mostriamo il contenuto principale
                    if (!introScreen.classList.contains('hidden')) {
                        showMainContent();
                        // Assicurati che il mainContent sia visibile prima di tentare di scrollare o aprire la card
                        // Aggiungiamo un piccolo ritardo extra per assicurare che la transizione sia completa
                        setTimeout(() => {
                            const targetId = this.dataset.target; // Ottieni l'ID della card da aprire dal data-target del bottone
                            toggleCard(targetId); // Apri la card cliccata
                            const targetElement = document.getElementById(targetId);
                            if (targetElement) {
                                // Scorri alla card appena aperta, posizionandola al centro della viewport
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 1100); // Leggermente pi√π lungo del setTimeout di showMainContent
                    } else {
                        // Se l'intro √® gi√† nascosta, apri semplicemente la card e scorri
                        const targetId = this.dataset.target;
                        toggleCard(targetId);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            });

            // 3. Event listeners per gli header delle singole card (per aprirle/chiuderle cliccando sull'header)
            allCards.forEach(card => {
                const cardHeader = card.querySelector('.card-header');
                cardHeader.addEventListener('click', function () {
                    const currentCardId = card.id; // Ottieni l'ID della card cliccata
                    toggleCard(currentCardId); // Apri/chiudi la card
                });
            });

            // Opzionale: Transizione automatica della schermata introduttiva dopo un certo tempo
            // Rimuovi o commenta la riga seguente se vuoi che l'utente debba sempre cliccare "Entra"
            // setTimeout(showMainContent, 5000); // Esempio: 5000ms = 5 secondi
        });
    </script>
</body>

</html>